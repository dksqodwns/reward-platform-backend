# 이벤트 보상 플랫폼 구축
### 작성자: 안병준

## 실행 방법
  ### 프로젝트 루트 경로에서 `sh start.sh`를 입력합니다.

## 프로젝트 설명
### AUTH
- 유저 등록, 로그인, 역할 관리를 담당합니다.
- `권한`을 정의하여 역할에 할당해서 확장성 있는 `RoleGuard`를 구현했습니다.

### EVENT
- 관리자가 이벤트와 보상을 자유롭게 등록 할 수 있도록 작성했습니다.
- 유저는 조건이 충족했을 경우, 이벤트에 할당 된 보상의 양이 남아있다면 보상을 받을 수 있습니다.
- 유저는 자신의 보상 요청 내역을 확인 할 수 있습니다.
- 관리자, 감사자는 모든 요청에 대한 내역을 조회 할 수 있습니다.

## 조건 검증 방식
- 
## 구현 중 했던 고민
1. 서비스 간 통신 방식에 대한 고민 
  #### <gRPC vs TCP vs 메시지 큐> 
- 중복 요청에 대한 검증을 요청 단에서 한번 더 막으려면 메시지 큐를 통해 요청 - 응답을 관리하는게 좋을 것 같지만, 조금 더 빠른 응답을 위해 gRPC, TCP 중에서 선택 하기로 함
- gRPC가 TCP에 비해 장점이 많지만, 목적이 이벤트를 관리 및 유저의 보상 요청 처리에 있으므로, TCP로 구현해도 무방하다고 판단함
- 추후, 오고 가야하는 데이터의 양이 많아지거나 retry등의 요구사항이 생기면 gRPC로 전환하는 것으로 계획

2. AccesToken 관리에 대한 고민
  #### <메모리에 저장 vs 쿠키에 저장 vs 공유 저장소에 저장>
- 서버 메모리에 저장해서 관리하는게 좋을 것 같지만, 분산 환경일 경우에는 정보가 공유되지 않을 수 있음
- `Redis`를 사용하기에는 오버 엔지니어링이라고 판단
- `AccessToken`의 만료 기간을 짧게 만들어서 `RefreshToken`을 통한 재발급 로직을 탈 수 있도록 함
- 강제 로그아웃같은 기능을 구현하려면 유저의 RefreshToken 값을 만료시키는 것으로 가능

3. 유저 중복 요청에 대한 고민
  - 유저의 보상 요청이 비교적 적은 기간
    - user_events 컬렉션에 유니크 인덱스를 걸어, 동일한 (userId, eventKey)가 insert를 시도하면 11000 duplicate key error를 내도록 함
    - insert가 성공하면 보상 지급 로직을 수행하고, 실패하면 409 에러를 냄
  - 유저 보상 요청이 비교적 잦은 기간
    - DB 샤딩: DB를 여러 서버에 나누어 저장하여, eventKey가 A인 레코드는 샤드 A에, B인 레코드는 샤드 B에 저장하는 식으로 처리하여, 부하를 분산시킨다.
    - 컬렉션 분할: 이벤트, 혹은 시간별로 컬렉션을 분할하여 데이터를 저장한다. (예, user_events_event_A 혹은 user_event_20250518)
    - 메시지 큐 적용
      1. 유저의 보상 요청을 Redis와 같은 분산 환경에서도 공유 할 수 있는 저장소에 저장하고, 중복된 데이터 삽입을 막는다.
      2. 1분마다 배치로 저장소에 적재되어있는 요청을 한번에 처리한다.
    - 새로운 컬렉션 생성
      - 이벤트 조건을 충족시킨 유저를 따로 빼서 테이블에 추가해놓고 사용

4. 유저 권한 관리에 대한 고민
   - 유저 권한 관리 위치
       - role 컬렉션을 따로 넣는다면?
         - 한 유저가 두 역할을 갖고있을 경우 중복 요청 필요
         - 새로운 역할을 추가 할 경우, 컬렉션뿐 아니라, 서비스, API 모두 늘어남
         - 사용자 목록을 조회 할 때, 컬렉션을 모두 순회해야 함
       - 유저 엔티티안에 넣는다면?
         - 조회, 검색 모두 한 컬렉션에서 인덱스만 걸면 가능
         - 새로운 역할 도입 할 때, 스키마 변경 및 마이그레이션 부담 감소
         - 유저 문서가 커질 수 있음
         - 역할에 대한 메타 데이터를 담고있는 엔터티 필요
   - 유저 권한 관리
     - USER, OPERATOR, AUDITOR, ADMIN 등 직급에 초점을 맞추는게 아니고, 행위에 초점을 맞춤
     - 이벤트 CRUD, 보상 CRUD, 유저 보상 CRUD 등 행위를 중심으로 권한을 만들어, 유저의 직급에 부여
     - 직급 및 권한 추가, 유지보수가 용이한 형태로 관리 가능
